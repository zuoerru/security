{% extends "base.html" %}

{% block title %}NVD 漏洞数据库{% endblock %}

{% block content %}
    <!-- 引入NVD专用样式 -->
    <link href="{{ url_for('static', filename='css/nvd-styles.css') }}" rel="stylesheet">
    
    <!-- 顶部标题区域 - 使用渐变背景美化 -->
    <div class="page-header d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center px-4">
        <h1>NVD 漏洞数据库</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <button id="sync-data-btn" class="btn btn-primary mr-2">手动同步数据</button>
            <button id="view-logs-btn" class="btn btn-secondary">查看同步日志</button>
            <div id="last-update" class="ml-4 text-muted small">最后更新: 加载中...</div>
        </div>
    </div>

    <!-- 日志查看悬浮窗口 -->
    <div id="logs-modal" class="fixed top-4 right-4 w-80 max-h-[70vh] bg-white rounded-lg shadow-xl z-1000 hidden border border-gray-200 overflow-hidden" style="position: fixed !important; top: 10px !important; right: 10px !important; z-index: 1000 !important; display: none;">
        <div class="p-4 border-b flex justify-between items-center">
            <h5 class="text-lg font-bold">同步日志</h5>
            <button id="close-logs-btn" class="text-gray-500 hover:text-gray-700 text-xl">
                &times;
            </button>
        </div>
        <div id="logs-content" class="p-3 overflow-y-auto h-[calc(100%-110px)]">
            加载日志中...
        </div>
        <div class="p-3 border-t">
            <button id="confirm-close-logs-btn" class="btn btn-secondary btn-sm">关闭</button>
        </div>
    </div>

    <!-- 日期范围选择器，默认隐藏 - 添加卡片样式 -->
    <div id="date-range-form" class="mb-4 p-4 border rounded bg-light hidden">
        <div class="row">
            <div class="col-md-2">
                <form id="search-form" method="get" action="{{ url_for('nvd.nvd_index') }}">
                    <input type="hidden" name="page" value="1">
                    <input type="hidden" name="per_page" value="{{ per_page }}">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="搜索CVE ID、描述、厂商或产品" name="search" value="{{ search_query }}">
                        <div class="input-group-append">
                            <button class="btn btn-primary" type="submit">搜索</button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="col-md-3">
                <label for="start_date" class="form-label">开始日期:</label>
                <input type="date" id="start_date" class="form-control" max="{{ today }}">
            </div>
            <div class="col-md-3">
                <label for="end_date" class="form-label">结束日期:</label>
                <input type="date" id="end_date" class="form-control" max="{{ today }}">
            </div>
            <div class="col-md-2">
                <label>&nbsp;</label>
                <button id="confirm-sync-btn" class="btn btn-success w-100">确认同步</button>
            </div>
        </div>
    </div>

    <!-- 数据表格 -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>CVE ID</th>
                            <th>发布日期</th>
                            <th>最后更新日期</th>
                            <th>描述</th>
                            <th>基础评分</th>
                            <th>严重性</th>
                            <th>向量字符串</th>
                            <th>厂商</th>
                            <th>产品</th>
                        </tr>
                    </thead>
                    <tbody id="nvd-data-body">
                        {% for item in data %}
                            <tr>
                                <td><a href="/nvd/cve/{{ item.cve_id }}" class="text-primary hover:underline">{{ item.cve_id }}</a></td>
                                <td>{{ item.published_date }}</td>
                                <td>{{ item.last_modified_date }}</td>
                                <td>{{ item.description[:100] }}{% if item.description|length > 100 %}...{% endif %}</td>
                                <td>{{ item.base_score or '-' }}</td>
                                <td>
                                    {% if item.base_severity %}
                                        <span class="badge 
                                            {% if item.base_severity == 'CRITICAL' %}bg-danger
                                            {% elif item.base_severity == 'HIGH' %}bg-warning text-dark
                                            {% elif item.base_severity == 'MEDIUM' %}bg-primary
                                            {% elif item.base_severity == 'LOW' %}bg-secondary
                                            {% else %}bg-info
                                            {% endif %}">
                                            {{ item.base_severity }}
                                        </span>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>{% if item.vector_string %}{{ item.vector_string[:30] }}{% if item.vector_string|length > 30 %}...{% endif %}{% else %}-{% endif %}</td>
                                <td>{{ item.vendor or '-' }}</td>
                                <td>{{ item.product or '-' }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 分页导航 -->
    <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center">
            {% if pagination.has_prev %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('nvd.nvd_index', page=pagination.prev_num, per_page=per_page, search=search_query) }}" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                        <span class="sr-only">Previous</span>
                    </a>
                </li>
            {% else %}
                <li class="page-item disabled">
                    <a class="page-link" href="#" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                        <span class="sr-only">Previous</span>
                    </a>
                </li>
            {% endif %}
            
            {% for page_num in pagination.iter_pages(left_edge=2, right_edge=2, left_current=2, right_current=2) %}
                {% if page_num %}
                    {% if page_num == pagination.page %}
                        <li class="page-item active">
                            <a class="page-link" href="#">{{ page_num }} <span class="sr-only">(current)</span></a>
                        </li>
                    {% else %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('nvd.nvd_index', page=page_num, per_page=per_page, search=search_query) }}">{{ page_num }}</a>
                        </li>
                    {% endif %}
                {% else %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                {% endif %}
            {% endfor %}
            
            {% if pagination.has_next %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('nvd.nvd_index', page=pagination.next_num, per_page=per_page, search=search_query) }}" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                        <span class="sr-only">Next</span>
                    </a>
                </li>
            {% else %}
                <li class="page-item disabled">
                    <a class="page-link" href="#" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                        <span class="sr-only">Next</span>
                    </a>
                </li>
            {% endif %}
        </ul>
    </nav>

    <!-- 每页显示条数选择器 -->
    <div class="text-center mt-2 mb-4">
        <div class="form-inline justify-content-center">
            <label for="per_page" class="mr-2">每页显示:</label>
            <select id="per_page" class="form-control form-control-sm mr-2">
                <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
                <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
            </select>
            <span class="text-muted small">总共 {{ total_items }} 条记录</span>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 设置默认日期为最近7天
            const today = new Date();
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(today.getDate() - 7);
            
            document.getElementById('start_date').valueAsDate = sevenDaysAgo;
            document.getElementById('end_date').valueAsDate = today;
            
            // 每页显示条数变更处理
            document.getElementById('per_page').addEventListener('change', function() {
                const per_page = this.value;
                const search_form = document.getElementById('search-form');
                const per_page_input = search_form.querySelector('input[name="per_page"]');
                per_page_input.value = per_page;
                search_form.submit();
            });
            
            // 标记最后更新时间
            updateLastUpdateTime();
            
            // 手动同步数据按钮点击事件
            document.getElementById('sync-data-btn').addEventListener('click', function() {
                const dateRangeForm = document.getElementById('date-range-form');
                dateRangeForm.classList.toggle('hidden');
            });
            
            // 确认同步按钮点击事件
            document.getElementById('confirm-sync-btn').addEventListener('click', function() {
                const startDate = document.getElementById('start_date').value;
                const endDate = document.getElementById('end_date').value;
                
                if (startDate && endDate) {
                    // 显示加载状态
                    document.getElementById('last-update').textContent = '正在同步数据...';
                    
                    // 执行同步
                    window.location.href = `{{ url_for('nvd.sync_data') }}?start_date=${startDate}&end_date=${endDate}`;
                } else {
                    alert('请选择有效的日期范围');
                }
            });
            
            // 查看日志按钮点击事件
            document.getElementById('view-logs-btn').addEventListener('click', function() {
                try {
                    // 显示悬浮窗口
                    const logsModal = document.getElementById('logs-modal');
                    logsModal.classList.remove('hidden');
                    // 设置所有关键样式确保显示
                    logsModal.style.display = 'block';
                    logsModal.style.position = 'fixed';
                    logsModal.style.top = '10px';
                    logsModal.style.right = '10px';
                    logsModal.style.zIndex = '9999';
                    
                    console.log('显示悬浮窗口 - 样式设置完成:', {
                        display: logsModal.style.display,
                        position: logsModal.style.position,
                        top: logsModal.style.top,
                        right: logsModal.style.right,
                        zIndex: logsModal.style.zIndex
                    });
                    
                    // 加载日志内容
                    loadLogs();
                } catch (error) {
                    console.error('打开日志窗口失败:', error);
                    alert('打开日志窗口失败，请刷新页面重试');
                }
            });
            
            // 关闭日志窗口按钮点击事件
            document.getElementById('close-logs-btn').addEventListener('click', function() {
                try {
                    const logsModal = document.getElementById('logs-modal');
                    if (logsModal) {
                        console.log('关闭日志窗口 - X按钮');
                        // 确保添加hidden类
                        logsModal.classList.add('hidden');
                        // 同时设置display: none作为后备
                        logsModal.style.display = 'none';
                    }
                } catch (error) {
                    console.error('关闭日志窗口失败:', error);
                }
            });
            
            // 确认关闭日志窗口按钮点击事件
            document.getElementById('confirm-close-logs-btn').addEventListener('click', function() {
                try {
                    const logsModal = document.getElementById('logs-modal');
                    if (logsModal) {
                        console.log('关闭日志窗口 - 关闭按钮');
                        // 确保添加hidden类
                        logsModal.classList.add('hidden');
                        // 同时设置display: none作为后备
                        logsModal.style.display = 'none';
                    }
                } catch (error) {
                    console.error('关闭日志窗口失败:', error);
                }
            });
            
            // 每10秒自动更新数据
            setInterval(function() {
                // 更新最后更新时间显示
                updateLastUpdateTime();
                
                // 只有在首页时才自动刷新数据，避免分页后也刷新
                if (window.location.href.includes('page=1') || !window.location.href.includes('page=')) {
                    // 刷新表格数据
                    refreshTableData();
                }
            }, 10000);
        });
        
        // 更新最后更新时间显示
        function updateLastUpdateTime() {
            const lastUpdateElement = document.getElementById('last-update');
            const now = new Date();
            lastUpdateElement.textContent = `最后更新: ${now.toLocaleString()}`;
        }
        
        // 刷新表格数据
        function refreshTableData() {
            // 这里应该通过AJAX请求获取最新数据，然后更新表格内容
            console.log('刷新数据：', new Date().toLocaleString());
            
            // 实际应用中应该调用API获取数据，然后更新表格
            // 获取当前的搜索参数
            const searchParams = new URLSearchParams(window.location.search);
            const searchQuery = searchParams.get('search') || '';
            const page = searchParams.get('page') || 1;
            const perPage = searchParams.get('per_page') || 20;
            const sortBy = searchParams.get('sort_by') || 'published_date';
            const sortOrder = searchParams.get('sort_order') || 'desc';
            
            // 构建API请求URL
            const baseUrl = window.location.origin + '/nvd/api/data';
            const apiUrl = baseUrl + '?search=' + encodeURIComponent(searchQuery) + '&page=' + page + '&per_page=' + perPage + '&sort_by=' + sortBy + '&sort_order=' + sortOrder;
            
            // 发送请求获取数据
            fetch(apiUrl)
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('网络响应错误: ' + response.status);
                    }
                    return response.json();
                })
                .then(function(data) {
                    if (data && data.data) {
                        // 更新表格内容
                        updateTableContent(data.data);
                    } else {
                        console.error('数据格式不正确');
                    }
                })
                .catch(function(error) {
                    console.error('获取数据失败:', error);
                });
        }
        
        // 更新表格内容
        function updateTableContent(data) {
            const tableBody = document.getElementById('nvd-data-body');
            
            if (data && data.length > 0) {
                // 清空表格
                tableBody.innerHTML = '';
                
                // 添加新数据行
                for (let i = 0; i < data.length; i++) {
                    const item = data[i];
                    const row = document.createElement('tr');
                    
                    // 构建严重性标签
                    let severityBadge = '-';
                    if (item.base_severity) {
                        let badgeClass = '';
                        switch (item.base_severity) {
                            case 'CRITICAL': badgeClass = 'bg-danger'; break;
                            case 'HIGH': badgeClass = 'bg-warning text-dark'; break;
                            case 'MEDIUM': badgeClass = 'bg-primary'; break;
                            case 'LOW': badgeClass = 'bg-secondary'; break;
                            default: badgeClass = 'bg-info'; break;
                        }
                        severityBadge = '<span class="badge ' + badgeClass + '">' + item.base_severity + '</span>';
                    }
                    
                    // 设置行内容
                    row.innerHTML = 
                        '<td><a href="/nvd/cve/' + item.cve_id + '" class="text-primary hover:underline">' + item.cve_id + '</a></td>' +
                        '<td>' + item.published_date + '</td>' +
                        '<td>' + item.last_modified_date + '</td>' +
                        '<td>' + (item.description ? (item.description.substring(0, 100) + (item.description.length > 100 ? '...' : '')) : '-') + '</td>' +
                        '<td>' + (item.base_score || '-') + '</td>' +
                        '<td>' + severityBadge + '</td>' +
                        '<td>' + (item.vector_string ? (item.vector_string.substring(0, 30) + (item.vector_string.length > 30 ? '...' : '')) : '-') + '</td>' +
                        '<td>' + (item.vendor || '-') + '</td>' +
                        '<td>' + (item.product || '-') + '</td>';
                    
                    tableBody.appendChild(row);
                }
            }
        }
        
        // 加载同步日志
        function loadLogs() {
            const logsContent = document.getElementById('logs-content');
            logsContent.innerHTML = '<div class="text-center text-muted">加载日志中...</div>';
            
            // 从服务器获取日志内容
            const baseUrl = window.location.origin + '/nvd/api/logs';
            fetch(baseUrl)
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('网络响应错误: ' + response.status);
                    }
                    return response.json();
                })
                .then(function(logs) {
                    console.log('获取到的日志数据:', logs);
                    if (logs && logs.length > 0) {
                        // 统计不同类型的日志数量
                        const autoLogsCount = logs.filter(log => log.action_type === 'auto').length;
                        const manualLogsCount = logs.filter(log => log.action_type === 'manual').length;
                        
                        let logsHTML = '<div class="mb-4 text-sm text-gray-500">共 ' + logs.length + ' 条日志 (自动同步: ' + autoLogsCount + ' 条, 手动同步: ' + manualLogsCount + ' 条)</div>';
                        logsHTML += '<ul class="list-unstyled">';
                        
                        // 按时间戳排序（确保最新的在前面）
                        const sortedLogs = logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                        
                        for (let i = 0; i < sortedLogs.length; i++) {
                            const log = sortedLogs[i];
                            const actionType = log.action_type === 'auto' ? '自动同步' : '手动同步';
                            const actionClass = log.action_type === 'auto' ? 'badge-secondary' : 'badge-primary';
                            const dateRange = log.start_date && log.end_date 
                                ? ' <small class="text-muted">(</small><small class="text-info">' + log.start_date + '</small> <small class="text-muted">至</small> <small class="text-info">' + log.end_date + '</small><small class="text-muted">)</small>' 
                                : '';
                            
                            // 使用标准Bootstrap样式
                            logsHTML += '<li class="p-3 bg-light rounded border border-gray-200 mb-3 shadow-sm">';
                            logsHTML += '<div class="text-sm text-gray-500 mb-2">' + log.timestamp + '</div>';
                            logsHTML += '<div class="d-flex flex-wrap align-items-center gap-2">';
                            logsHTML += '<span class="badge ' + actionClass + ' px-2 py-1">' + actionType + '</span>';
                            logsHTML += '<span class="text-gray-800">完成，新增 <span class="font-bold text-primary">' + log.count + '</span> 条记录</span>';
                            logsHTML += dateRange;
                            logsHTML += '</div>';
                            logsHTML += '</li>';
                        }
                        logsHTML += '</ul>';
                        logsContent.innerHTML = logsHTML;
                    } else {
                        logsContent.innerHTML = '<div class="text-center text-muted py-4">暂无同步日志</div>';
                    }
                })
                .catch(function(error) {
                    console.error('获取日志失败:', error);
                    logsContent.innerHTML = '<div class="text-center text-danger py-4">获取日志失败，请稍后重试</div>';
                });
        }
    </script>
{% endblock %}