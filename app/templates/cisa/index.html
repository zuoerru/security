{% extends "base.html" %}

{% block content %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">CISA 已知被利用漏洞目录</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group mr-2">
                <a href="{{ url_for('cisa.sync_data') }}" class="btn btn-sm btn-outline-secondary">手动同步数据</a>
            </div>
            <div class="btn-group">
                <span id="last-update" class="btn btn-sm btn-outline-info disabled">最后更新: 加载中...</span>
            </div>
        </div>
    </div>

    <!-- 搜索框和分页选项 -->
    <div class="mb-4">
        <form id="search-form" method="get" action="{{ url_for('cisa.cisa_index') }}">
            <input type="hidden" name="page" value="1">
            <input type="hidden" name="per_page" value="{{ per_page }}">
            <div class="input-group">
                <input type="text" class="form-control" placeholder="搜索厂商、产品、漏洞名称或CVE ID" name="search" value="{{ search_query }}">
                <div class="input-group-append">
                    <button class="btn btn-primary" type="submit">搜索</button>
                </div>
            </div>
        </form>
        
        <!-- 每页显示条数选择器 -->
        <div class="mt-2 d-flex justify-content-between align-items-center">
            <div>
                <label for="per_page" class="mr-2">每页显示:</label>
                <select id="per_page" class="form-control-sm">
                    {% for option in per_page_options %}
                        <option value="{{ option }}" {% if per_page == option %}selected{% endif %}>{{ option }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="text-muted">
                共 {{ total_count }} 条记录
            </div>
        </div>
    </div>

    <!-- 数据表格 -->
    <div class="table-responsive">
        <table id="cisa-data-table" class="table table-striped table-sm">
            <thead>
                <tr>
                    <th>漏洞ID</th>
                    <th>厂商/项目</th>
                    <th>产品</th>
                    <th>漏洞名称</th>
                    <th>添加日期</th>
                    <th>CVE ID</th>
                    <th>截止日期</th>
                </tr>
            </thead>
            <tbody id="cisa-data-body">
                {% if data %}
                    {% for item in data %}
                        <tr>
                            <td>{{ item.vuln_id }}</td>
                            <td>{{ item.vendor_project }}</td>
                            <td>{{ item.product or '-' }}</td>
                            <td>{{ item.vulnerability_name }}</td>
                            <td>{{ item.date_added.strftime('%Y-%m-%d') }}</td>
                            <td>{{ item.cve_id or '-' }}</td>
                            <td>{{ item.due_date.strftime('%Y-%m-%d') if item.due_date else '-' }}</td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="7" class="text-center">暂无数据，请点击"手动同步数据"按钮获取数据</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <!-- 分页导航 -->
    {% if pagination and pagination.pages > 1 %}
    <div class="mt-4 d-flex justify-content-center">
        <nav aria-label="Page navigation">
            <ul class="pagination">
                <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('cisa.cisa_index', search=search_query, page=pagination.prev_num, per_page=per_page) }}" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                
                {% for page_num in pagination.iter_pages(left_edge=2, right_edge=2, left_current=2, right_current=2) %}
                    {% if page_num %}
                        <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                            <a class="page-link" href="{{ url_for('cisa.cisa_index', search=search_query, page=page_num, per_page=per_page) }}">{{ page_num }}</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled"><span class="page-link">...</span></li>
                    {% endif %}
                {% endfor %}
                
                <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('cisa.cisa_index', search=search_query, page=pagination.next_num, per_page=per_page) }}" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            </ul>
        </nav>
    </div>
    {% endif %}

    <script>
        // 获取当前搜索查询、页码和每页显示条数
        var currentSearch = '{{ search_query }}';
        var currentPage = {{ pagination.page if pagination else 1 }};
        var currentPerPage = {{ per_page }};
        
        // 更新表格数据的函数
        function updateTableData() {
            // 构建API URL，包含搜索参数和分页参数
            var apiUrl = '{{ url_for('cisa.api_data') }}';
            var queryParams = new URLSearchParams();
            
            if (currentSearch) {
                queryParams.append('search', currentSearch);
            }
            queryParams.append('page', currentPage);
            queryParams.append('per_page', currentPerPage);
            
            // 发送AJAX请求获取最新数据
            fetch(apiUrl + '?' + queryParams.toString())
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('网络响应异常');
                    }
                    return response.json();
                })
                .then(function(result) {
                    var tableBody = document.getElementById('cisa-data-body');
                    var lastUpdate = document.getElementById('last-update');
                    var data = result.data;
                    
                    // 清空表格
                    tableBody.innerHTML = '';
                    
                    // 更新表格内容
                    if (data.length > 0) {
                        for (var i = 0; i < data.length; i++) {
                            var item = data[i];
                            var row = document.createElement('tr');
                            row.innerHTML = '<td>' + item.vuln_id + '</td><td>' + item.vendor_project + '</td><td>' + (item.product || '-') + '</td><td>' + item.vulnerability_name + '</td><td>' + item.date_added + '</td><td>' + (item.cve_id || '-') + '</td><td>' + (item.due_date || '-') + '</td>';
                            tableBody.appendChild(row);
                        }
                    } else {
                        var emptyRow = document.createElement('tr');
                        emptyRow.innerHTML = '<td colspan="7" class="text-center">暂无数据，请点击"手动同步数据"按钮获取数据</td>';
                        tableBody.appendChild(emptyRow);
                    }
                    
                    // 更新最后更新时间
                    var now = new Date();
                    var formattedTime = now.toLocaleTimeString();
                    lastUpdate.textContent = '最后更新: ' + formattedTime;
                })
                .catch(function(error) {
                    console.error('获取数据时出错:', error);
                });
        }
        
        // 立即更新一次数据
        updateTableData();
        
        // 设置定时器，每10秒更新一次数据
        setInterval(updateTableData, 10000);
        
        // 为搜索表单添加提交事件监听
        document.getElementById('search-form').addEventListener('submit', function(e) {
            // 正常提交表单，页面会刷新
            // 新页面加载后，会重新启动定时器
        });
        
        // 为每页显示条数选择器添加变化事件监听
        document.getElementById('per_page').addEventListener('change', function(e) {
            currentPerPage = parseInt(this.value);
            currentPage = 1; // 重置为第一页
            
            // 更新表单中的每页显示条数并提交表单
            var form = document.getElementById('search-form');
            form.querySelector('input[name="per_page"]').value = currentPerPage;
            form.querySelector('input[name="page"]').value = currentPage;
            form.submit();
        });
        
        // 为分页链接添加点击事件监听
        var paginationLinks = document.querySelectorAll('.pagination a');
        for (var j = 0; j < paginationLinks.length; j++) {
            paginationLinks[j].addEventListener('click', function(e) {
                // 正常的分页导航通过href跳转，这里不需要额外处理
            });
        }
    </script>
{% endblock %}